<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/bootstrap-grid.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/styles.css" />
    <title>Gomoku</title>
    <script src="/socket.io/socket.io.js"></script>
    <!-- TODO: Replace CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <div class="row d-flex justify-content-center">
          <div class="col-5">
            <div id="setupBox" v-if="gomokuConnection.status === 'SETUP'">
              <h1 class="text-center">Gomoku</h1>
              <div class="row">
                <div class="col-12 d-flex justify-content-center">
                  <input 
                    class="setupInput"
                    type="text"
                    name="createRoom"
                    placeholder="Enter room name"
                    v-model="gomokuConnection.roomName"
                  />
                </div>
              </div>
              <div class="row d-flex justify-content-center pt-3">
                <div class="col-5 d-flex justify-content-center">
                  <button class="setupButton p-2" @click="onCreateRoom()">
                    Create Room
                  </button>
                </div>
                <div class="col-5 d-flex justify-content-center">
                  <button class="setupButton p-2" @click="onConnectRoom()">
                    Connect Room
                  </button>
                </div>
              </div>
              <div class="row d-flex justify-content-center pt-3">
                <div class="col-2">
                  <div
                    class="setupSwitch p-1"
                    :class="gomokuConnection.firstPlayer === 'CREATOR' ? 'selected' : ''"
                    @click="gomokuConnection.firstPlayer = 'CREATOR'"
                  >
                    <div class="black stone"></div>
                  </div>
                </div>
                <div class="col-2">
                  <div
                    class="setupSwitch p-1"
                    :class="gomokuConnection.firstPlayer === 'RANDOM' ? 'selected' : ''"
                    @click="gomokuConnection.firstPlayer = 'RANDOM'"
                  >
                    <div class="multicolor stone"></div>
                  </div>
                </div>
                <div class="col-2">
                  <div
                    class="setupSwitch p-1"
                    :class="gomokuConnection.firstPlayer === 'OPPONENT' ? 'selected' : ''"
                    @click="gomokuConnection.firstPlayer = 'OPPONENT'"
                  >
                    <div class="white stone"></div>
                  </div>
                </div>
              </div>
              
              <div class="row d-flex justify-content-center pt-3">
                <div class="col-6 d-flex justify-content-center">
                  <input
                  type="number"
                  class="setupTimer"
                  v-model="gomoku.maxTime"
                  placeholder="Seconds"
                  />
                  <p>seconds</p>
                  <!-- <legend>seconds</legend>  -->
                </div>
              </div>
              
              <p>{{gomokuConnection.errorMessage}}</p>
          </div>
        </div>
      </div>
    </div>

      <div class="container grid">
        <div class="titleBlock">
          <div
            v-if="gomokuConnection.status === 'PLAY' || gomokuConnection.status === 'WAITING'"
            class="roomName"
          >
            {{gomokuConnection.roomName}}
          </div>
        </div>
        <div class="youBlock">
          <div
            v-if="gomokuConnection.status === 'PLAY' || gomokuConnection.status === 'WAITING'"
            class="playerPanel"
          >
            <div
              :class="gomokuConnection.userId === gomoku.players.first.id || gomokuConnection.firstPlayer === 'CREATOR' ? 'black stone' : 'white stone'"
            ></div>
            <p>
              You
              <b>
                ( {{gomokuConnection.userId === gomoku.players.first.id ?
                gomoku.formatTime(gomoku.players.first.timer) :
                gomoku.formatTime(gomoku.players.second.timer)}} )
              </b>
            </p>
            <br />
            <p>
              <i v-if="gomokuConnection.status === 'WAITING'">
                Waiting for another player. <br />
                Invite someone with the room name:
                <b>{{gomokuConnection.roomName}}</b>
              </i>
              <i
                v-if="gomokuConnection.status === 'PLAY' && gomoku.winner === null"
              >
                {{gomoku.activePlayer === gomokuConnection.userId ? "Your turn."
                : "Waiting for opponent."}}
              </i>
              <i v-if="gomoku.winner === gomokuConnection.userId">You won!</i>
              <i v-if="gomoku.winner === gomokuConnection.opponent">
                You lose...
              </i>
            </p>
          </div>
        </div>
        <div class="boardBlock">
          <table
            v-if="gomokuConnection.status === 'PLAY' || gomokuConnection.status === 'WAITING'"
            v-if="gomoku !== {}"
            class="board"
          >
            <tr v-for="(row, y) in gomoku.board">
              <td class="tableIndex tableIndexColumn d-none d-lg-table-cell">
                {{gomoku.boardSize - y}}
              </td>
              <td
                v-for="(cell, x) in row"
                @click="onClick(x, y)"
                class="tableField"
                :class="[y === gomoku.lastMove[0] && x === gomoku.lastMove[1] ? 'lastMove' : '',
                  gomoku.isInWinLine(x, y) && !gomoku.isReplay() ? 'inWinLine': '']"
              >
                <div
                  class="black stone"
                  v-if="gomoku.board[y][x] === gomoku.players.first.id && gomokuConnection.status === 'PLAY'"
                ></div>
                <div
                  class="white stone"
                  v-if="gomoku.board[y][x] === gomoku.players.second.id && gomokuConnection.status === 'PLAY'"
                ></div>
              </td>
            </tr>
            <tr>
              <td class="d-none d-lg-table-cell"></td>
              <td
                class="tableIndex tableIndexRow d-none d-lg-table-cell"
                v-for="n in gomoku.boardSize"
              >
                {{String.fromCharCode("A".charCodeAt(0) + n - 1)}}
              </td>
            </tr>
          </table>
        </div>
        <div class="opponentBlock">
          <div v-if="gomokuConnection.status === 'PLAY'" class="playerPanel">
            <div
              :class="gomokuConnection.userId === gomoku.players.first.id ? 'white stone' : 'black stone'"
            ></div>
            <p>
              Opponent
              <b>
                ( {{gomokuConnection.userId !== gomoku.players.first.id ?
                gomoku.formatTime(gomoku.players.first.timer) :
                gomoku.formatTime(gomoku.players.second.timer)}} )
              </b>
            </p>
          </div>
        </div>
        <div class="replayBlock">
          <div v-if="gomokuConnection.status === 'PLAY'" class="replay">
            <div class="notation">
              <table>
                <tr v-for="(note, n) in gomoku.notation">
                  <td>{{n % 2 == 0 ? Math.floor(n / 2) + "." : "" }}</td>
                  <td
                    @click="gomoku.stepTo(n)"
                    :class="n%2 == 0 && gomoku.lastMove[0] === note[1] && gomoku.lastMove[1] === note[0] ? 'selectedMove': ''"
                  >
                    {{n % 2 == 0 ? gomoku.formatNote(gomoku.notation[n][0],
                    gomoku.notation[n][1]) + "," : "" }}
                  </td>
                  <td
                    @click="gomoku.stepTo(n+1)"
                    :class="n%2 == 0 && gomoku.notation[n+1] && gomoku.lastMove[0] === gomoku.notation[n+1][1] && gomoku.lastMove[1] === gomoku.notation[n+1][0] ? 'selectedMove': ''"
                  >
                    {{n % 2 == 0 && gomoku.notation[n+1] ?
                    gomoku.formatNote(gomoku.notation[n+1][0] ,
                    gomoku.notation[n+1][1]) : "" }}
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/gomoku.js"></script>
    <script src="/gomokuConnection.js"></script>
    <script src="/client.js"></script>
  </body>
</html>
